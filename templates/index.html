<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>部活練習希望調査</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>部活練習希望調査</h1>
        <p>today: {{ today }}</p>
        {% for calinfo in calendars %}
        <div class="calendar">
            <h2>{{ calinfo.year }}年 {{ calinfo.month_name }}</h2>
            <table>
                <thead>
                    <tr>
                        <th>日</th>
                        <th>月</th>
                        <th>火</th>
                        <th>水</th>
                        <th>木</th>
                        <th>金</th>
                        <th>土</th>
                    </tr>
                </thead>
                <tbody>
                    {% for week in calinfo.calendar %}
                    <tr>
                        {% for day in week %}
                            {% if day == 0 %}
                                <td class="empty"></td>
                            {% else %}
                                {% set d = day|int %}
                                {% set y = calinfo.year|int %}
                                {% set m = calinfo.month|int %}
                                {% set date_key = y ~ '-' ~ m ~ '-' ~ d %}
                                {% set slots = time_slots.get(date_key, []) %}
                                {% set is_past = (y == today.year and m == today.month and d < today.day) or
                                                 (y == today.year and m < today.month) or
                                                 (y < today.year) %}
                                <td class="day{% if is_past %} past{% endif %}{% if date_key not in valid_dates %} not-selectable{% endif %}{% if date_key in booked_dates %} booked{% endif %}" data-year="{{ y }}" data-month="{{ m }}" data-day="{{ d }}">
                                    <div class="day-number">{{ day }}</div>
                                    <div class="time-options">
                                        {% if date_key in valid_dates %}
                                            {% for slot in slots %}
                                                <span class="time-label">{{ slot }}</span><br>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>

    <!-- 時間帯選択モーダル -->
    <div id="timeSlotModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modalTitle">練習時間を選択してください</h3>
            <div class="time-slots">
                <!-- JSでボタンを動的生成 -->
            </div>
            <div id="nameForm" style="display:none; margin-top:20px;">
                <input type="text" id="userName" placeholder="名前を入力してください" style="padding:8px; width:80%; margin-bottom:10px;">
                <input type="text" id="bandName" placeholder="バンド名を入力してください" style="padding:8px; width:80%; margin-bottom:10px;">
                <button id="submitBtn" style="padding:8px 16px;">送信</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let selectedDate = null;
            let selectedTimeSlot = null;
            const modal = document.getElementById('timeSlotModal');
            const closeBtn = document.getElementsByClassName('close')[0];
            const timeSlots = document.getElementsByClassName('time-slot');
            const nameForm = document.getElementById('nameForm');
            const userNameInput = document.getElementById('userName');
            const bandNameInput = document.getElementById('bandName');
            const submitBtn = document.getElementById('submitBtn');
            const timeSlotsDiv = document.querySelector('.time-slots');

            // 日付をクリックしたときの処理
            document.querySelectorAll('.day').forEach(day => {
                if (day.classList.contains('past')) return; // 過去日は無効
                day.addEventListener('click', async function() {
                    const year = parseInt(this.dataset.year);
                    const month = parseInt(this.dataset.month);
                    const dayNum = parseInt(this.dataset.day);
                    selectedDate = { year, month, day: dayNum };
                    selectedTimeSlot = null;
                    nameForm.style.display = 'none';
                    userNameInput.value = '';
                    bandNameInput.value = ''; // バンド名もクリア

                    // モーダルのタイトルに選択した日付を表示
                    const modalTitle = document.getElementById('modalTitle');
                    modalTitle.textContent = `${month}月${dayNum}日の練習時間を選択してください`;

                    // ここで時間帯取得
                    const url = `get_time_slots/${year}/${month}/${dayNum}`;
                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        modal.style.display = 'block';

                        // ここでモーダルの時間帯ボタンを動的に生成
                        const timeSlotsDiv = document.querySelector('.time-slots');
                        timeSlotsDiv.innerHTML = ''; // 既存をクリア
                        data.time_slots.forEach(slot => {
                            // 各時間帯のコンテナを作成
                            const slotContainer = document.createElement('div');
                            slotContainer.className = 'slot-container';
                            slotContainer.style.marginBottom = '12px';
                            
                            // 時間帯ボタンを作成
                            const btn = document.createElement('button');
                            btn.className = 'time-slot';
                            btn.dataset.slot = slot.id;
                            btn.textContent = slot.label;
                            btn.onclick = function() {
                                selectedTimeSlot = slot.id;
                                document.querySelectorAll('.time-slot').forEach(b => b.classList.remove('selected'));
                                btn.classList.add('selected');
                                nameForm.style.display = 'block';
                            };
                            
                            // 予約者名リストを表示
                            const usersDiv = document.createElement('div');
                            usersDiv.className = 'slot-users';
                            usersDiv.style.fontSize = '0.9em';
                            usersDiv.style.color = '#555';
                            usersDiv.style.marginTop = '4px';
                            if (slot.users && slot.users.length > 0) {
                                // 予約者名とバンド名をクリック可能な形式で表示
                                const userElements = slot.users.map(user => {
                                    if (typeof user === 'object' && user.name && user.band_name) {
                                        const userSpan = document.createElement('span');
                                        userSpan.className = 'user-name';
                                        userSpan.textContent = `${user.name}（${user.band_name}）`;
                                        userSpan.style.cursor = 'pointer';
                                        userSpan.style.color = '#007bff';
                                        userSpan.style.textDecoration = 'underline';
                                        userSpan.style.marginRight = '8px';
                                        
                                        // クリックイベントを追加
                                        userSpan.addEventListener('click', function(e) {
                                            e.stopPropagation();
                                            showCancelDialog(user.name, user.band_name, slot.id, selectedDate);
                                        });
                                        
                                        return userSpan;
                                    } else if (typeof user === 'string') {
                                        // 既存の文字列形式の場合はそのまま表示（後方互換性）
                                        const userSpan = document.createElement('span');
                                        userSpan.textContent = user;
                                        return userSpan;
                                    }
                                    return null;
                                }).filter(element => element !== null);
                                
                                if (userElements.length > 0) {
                                    const label = document.createElement('span');
                                    label.textContent = '予約者: ';
                                    usersDiv.appendChild(label);
                                    userElements.forEach((element, index) => {
                                        usersDiv.appendChild(element);
                                        if (index < userElements.length - 1) {
                                            const comma = document.createElement('span');
                                            comma.textContent = ', ';
                                            usersDiv.appendChild(comma);
                                        }
                                    });
                                } else {
                                    usersDiv.textContent = '';
                                }
                            } else {
                                usersDiv.textContent = '';
                            }
                            
                            // コンテナにボタンと予約者リストを追加
                            slotContainer.appendChild(btn);
                            slotContainer.appendChild(usersDiv);
                            
                            // タイムスロットdivにコンテナを追加
                            timeSlotsDiv.appendChild(slotContainer);
                        });
                    } catch (error) {
                        console.error('時間帯取得エラー:', error);
                        alert('時間帯の取得に失敗しました。');
                        return;
                    }
                });
            });

            // 送信ボタンを押したときの処理
            submitBtn.addEventListener('click', async function() {
                const userName = userNameInput.value.trim();
                const bandName = bandNameInput.value.trim();
                if (!userName) {
                    alert('名前を入力してください');
                    return;
                }
                if (!bandName) {
                    alert('バンド名を入力してください');
                    return;
                }
                if (!selectedTimeSlot) {
                    alert('時間帯を選択してください');
                    return;
                }
                try {
                    const response = await fetch('submit_practice', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ...selectedDate,
                            time_slot: selectedTimeSlot,
                            user_name: userName,
                            band_name: bandName
                        })
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    modal.style.display = 'none';
                    alert('送信が完了しました！');
                } catch (error) {
                    console.error('送信エラー:', error);
                    alert('送信に失敗しました。');
                }
            });

            // モーダルを閉じる
            closeBtn.onclick = function() {
                modal.style.display = 'none';
            }
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }

            // キャンセル確認ダイアログを表示する関数
            function showCancelDialog(userName, bandName, timeSlot, date) {
                // 既存のポップアップがあれば削除
                const existingPopup = document.querySelector('.cancel-popup');
                const existingOverlay = document.querySelector('.popup-overlay');
                if (existingPopup) existingPopup.remove();
                if (existingOverlay) existingOverlay.remove();

                // オーバーレイを作成
                const overlay = document.createElement('div');
                overlay.className = 'popup-overlay';

                // ポップアップを作成
                const popup = document.createElement('div');
                popup.className = 'cancel-popup';
                popup.innerHTML = `
                    <h3>予約キャンセル確認</h3>
                    <p>${userName}（${bandName}）さんの<br>
                    ${date.month}月${date.day}日 ${timeSlot}の予約を<br>
                    キャンセルしますか？</p>
                    <div class="cancel-buttons">
                        <button class="cancel-btn cancel-confirm">キャンセル</button>
                        <button class="cancel-btn cancel-cancel">やめる</button>
                    </div>
                `;

                // イベントリスナーを追加
                popup.querySelector('.cancel-confirm').addEventListener('click', async function() {
                    try {
                        const response = await fetch('/cancel_practice', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                year: date.year,
                                month: date.month,
                                day: date.day,
                                user_name: userName,
                                time_slot: timeSlot
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        if (result.status === 'success') {
                            alert('予約をキャンセルしました');
                            // ページをリロードして最新の状態を表示
                            location.reload();
                        } else {
                            alert('キャンセルに失敗しました: ' + result.message);
                        }
                    } catch (error) {
                        console.error('キャンセルエラー:', error);
                        alert('キャンセルに失敗しました。');
                    } finally {
                        // ポップアップを閉じる
                        popup.remove();
                        overlay.remove();
                    }
                });

                popup.querySelector('.cancel-cancel').addEventListener('click', function() {
                    popup.remove();
                    overlay.remove();
                });

                // オーバーレイクリックで閉じる
                overlay.addEventListener('click', function() {
                    popup.remove();
                    overlay.remove();
                });

                // DOMに追加
                document.body.appendChild(overlay);
                document.body.appendChild(popup);
            }
        });
    </script>
</body>
</html> 